version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - node -v || { echo "Node.js installation failed"; exit 1; }
        - npm -v || { echo "npm installation failed"; exit 1; }
        - 'echo "Current directory: $(pwd)"'
        - ls -la
        - cd frontend || { echo "frontend directory not found"; exit 1; }
        - 'echo "Frontend directory contents:"'
        - ls -la
        - 'echo "Installing dependencies..."'
        - npm ci --include=dev || npm install --include=dev  # Install all dependencies including dev dependencies
        - 'echo "Dependencies installed. Checking if vite is available:"'
        - npx vite --version || { echo "Vite not found after installation"; exit 1; }
    build:
      commands:
        - 'echo "Building frontend..."'
        - 'echo "Environment variables:"'
        - 'echo "NODE_ENV: $NODE_ENV"'
        - 'echo "VITE_DATA_COLLECTION_API: ${VITE_DATA_COLLECTION_API:+SET}"'
        - npm run build  # Run build from frontend
        - 'echo "Build completed. Contents of dist:"'
        - ls -la dist/
  artifacts:
    baseDirectory: frontend/dist  # Output should be in frontend/dist
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
      - frontend/.npm-cache/**/*
